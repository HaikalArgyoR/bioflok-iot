<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bioflok-IoT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --navy-blue: #0a2463;
            --teal: #3e92cc;
            --aqua: #7bdff2;
            --light-blue: #d6f8ff;
            --white: #ffffff;
            --coral: #ff6b6b;
            --sea-green: #4ecdc4;
            --sun-yellow: #ffe66d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, var(--navy-blue), var(--teal));
            color: var(--navy-blue);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            background-color: rgba(10, 36, 99, 0.8);
            backdrop-filter: blur(5px);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 30px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
            color: var(--aqua);
            animation: wave 3s infinite ease-in-out;
        }

        .logo-text {
            color: white;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .sidebar {
            width: 80px;
            background-color: rgba(10, 36, 99, 0.9);
            height: calc(100vh - 70px);
            position: fixed;
            top: 70px;
            left: 0;
            transition: width 0.3s ease;
            overflow: hidden;
            z-index: 900;
        }

        .sidebar:hover {
            width: 220px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .menu-item:hover {
            background-color: rgba(126, 217, 247, 0.2);
        }

        .menu-item:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(126, 217, 247, 0.4), transparent);
            animation: waveHover 1.5s infinite;
        }

        .menu-icon {
            font-size: 20px;
            min-width: 40px;
            text-align: center;
        }

        .menu-text {
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .menu-text,
        .sidebar.mobile-active .menu-text {
            opacity: 1;
        }

        .main-content {
            margin-left: 80px;
            margin-top: 70px;
            padding: 30px;
            transition: margin-left 0.3s ease;
        }

        .sidebar:hover ~ .main-content {
            margin-left: 220px;
        }

        .card {
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%237bdff2'%3E%3Cpath d='M12,20A6,6 0 0,1 6,14C6,10 12,3.25 12,3.25C12,3.25 18,10 18,14A6,6 0 0,1 12,20Z' /%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.3;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .parameter-title {
            font-size: 14px;
            color: var(--navy-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parameter-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--navy-blue);
            margin: 10px 0;
        }

        .parameter-unit {
            font-size: 16px;
            color: var(--teal);
            margin-left: 5px;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--aqua), var(--teal));
            border-radius: 4px;
            width: 0%;
            transition: width 1s ease;
        }

        .fish-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .fish-tab {
            padding: 10px 20px;
            background-color: white;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: fit-content;
        }

        .fish-tab.active {
            background: linear-gradient(90deg, var(--aqua), var(--teal));
            color: white;
            box-shadow: 0 4px 10px rgba(62, 146, 204, 0.3);
        }

        .fish-tab .fish-icon {
            animation: fishSwim 2s infinite ease-in-out;
        }
        .fish-tab.active .fish-icon {
            animation: fishSwim 1s infinite ease-in-out;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, var(--light-blue), var(--aqua));
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--teal);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233e92cc'%3E%3Cpath d='M12,20A6,6 0 0,1 6,14C6,10 12,3.25 12,3.25C12,3.25 18,10 18,14A6,6 0 0,1 12,20Z' /%3E%3C/svg%3E");
            background-size: 60%;
            background-position: center;
            background-repeat: no-repeat;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(90deg, var(--aqua), var(--teal));
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 40px;
            background: linear-gradient(90deg, transparent, rgba(123, 223, 242, 0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        input:checked + .toggle-slider::after {
            opacity: 1;
            animation: wavePulse 2s infinite;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 30px 0;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 20px;
            min-width: 30px;
            text-align: center;
        }

        .notification.warning {
            border-left: 5px solid var(--sun-yellow);
        }

        .notification.critical {
            border-left: 5px solid var(--coral);
        }

        .notification.safe {
            border-left: 5px solid var(--sea-green);
        }

        .footer {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            text-align: center;
            margin-top: 40px;
            border-radius: 16px 16px 0 0;
        }

        .copyright {
            color: var(--teal);
            font-size: 14px;
        }

        @keyframes fishSwim {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(1px); }
        }

        @keyframes waveHover {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        @keyframes wavePulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        @keyframes bubbleRise {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-20px) scale(1); opacity: 0; }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

       /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                left: -100%;
                transition: left 0.3s ease;
            }
            .sidebar.mobile-active {
                left: 0;
                width: 220px;
            }
            .sidebar.mobile-active .menu-text {
                opacity: 1;
            }
            .main-content {
                margin-left: 0;
            }
            .main-content.mobile-active {
                margin-left: 220px;
            }
            .parameter-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 23px;
                left: 20px;
                z-index: 1100;
                color: white;
                font-size: 24px;
                cursor: pointer;
            }
            .header {
                padding-left: 70px;
                justify-content: flex-start;
                gap: 10px;
            }
            .logo {
                margin-left: 10px;
            }
        }
        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 15px 0 70px;
            }
            .logo-text {
                font-size: 18px;
            }
            .main-content {
                padding: 20px 15px;
            }
            .parameter-grid {
                grid-template-columns: 1fr;
            }
            .mobile-menu-toggle {
                left: 15px;
            }
        }

        /* MQTT Status Indicator */
        .mqtt-status {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-connected {
            background: #00ff00;
            box-shadow: 0 0 8px #00ff00;
        }
        .status-disconnected {
            background: #ff0000;
            box-shadow: 0 0 8px #ff0000;
        }
    </style>
</head>
<body>
    <!-- MQTT Status Indicator -->
    <div class="mqtt-status">
        <span class="status-indicator status-disconnected" id="mqtt-status-indicator"></span>
        <span id="mqtt-status-text">MQTT: Disconnected</span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <img src="logo_ikan.png" alt="AquaDrum" class="h-16 w-16 object-contain aspect-square">
            </div>
            <div class="logo-text">Monitoring Kualitas Air Kolam Bioflok Berbasis IoT</div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <a href="#dashboard" class="menu-item">
            <div class="menu-icon">
                <i class="fas fa-home"></i>
            </div>
            <div class="menu-text">Dashboard</div>
        </a>
        <a href="#setpoint" class="menu-item">
            <div class="menu-icon">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div class="menu-text">Set-Point</div>
        </a>
        <a href="#manual-control" class="menu-item">
            <div class="menu-icon">
                <i class="fas fa-gamepad"></i>
            </div>
            <div class="menu-text">Manual Control</div>
        </a>
        <a href="#grafik" class="menu-item">
            <div class="menu-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="menu-text">Grafik</div>
        </a>
        <a href="#notifikasi" class="menu-item">
            <div class="menu-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="menu-text">Notifikasi</div>
        </a>
    </nav>

    <!-- Mobile Sidebar Toggle -->
    <div class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard">
            <h2 class="text-2xl font-semibold text-white mb-6">Dashboard</h2>
            
            <div class="parameter-grid">
                <!-- Welcome Card -->
                <div class="card" style="grid-column: span 2; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; position: relative; overflow: hidden;">
                    <img src="koi-fish-carp-japanese.jpg" 
                         alt="Aquaculture" 
                         style="position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
                    <div style="position: absolute; width: 100%; height: 100%; background-color: rgba(10, 36, 99, 0.7); z-index: 1;"></div>
                    <div style="position: relative; z-index: 2; text-align: center; padding: 20px;">
                        <h3 class="text-3xl font-bold text-white mb-2">Bioflok IoT</h3>
                        <p class="text-white opacity-90 text-center max-w-md">Monitoring Aquaculture System</p>
                    </div>
                </div>
                
                <!-- Temperature Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-thermometer-half"></i>
                        <span>Suhu Air</span>
                    </div>
                    <div class="parameter-value">
                        <span id="current-temp">0.0</span><span class="parameter-unit">째C</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="temp-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- pH Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-flask"></i>
                        <span>pH Air</span>
                    </div>
                    <div class="parameter-value">
                        <span id="current-ph">0.0</span><span class="parameter-unit">pH</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="ph-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- DO Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-wind"></i>
                        <span>Oksigen Terlarut</span>
                    </div>
                    <div class="parameter-value">
                        <span id="current-do">0.0</span><span class="parameter-unit">mg/L</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="do-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Turbidity Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-tint"></i>
                        <span>Kekeruhan (NTU)</span>
                    </div>
                    <div class="parameter-value">
                        <span id="current-ntu">0.0</span><span class="parameter-unit">NTU</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="ntu-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- TDS Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-tint"></i>
                        <span>TDS</span>
                    </div>
                    <div class="parameter-value">
                        <span id="current-tds">0.0</span><span class="parameter-unit">ppm</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="tds-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Feed Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-utensils"></i>
                        <span>Pakan Hari Ini</span>
                    </div>
                    <div class="parameter-value">
                        0<span class="parameter-unit">x</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- System Status Card -->
                <div class="card">
                    <div class="parameter-title">
                        <i class="fas fa-heartbeat"></i>
                        <span>Status Sistem</span>
                    </div>
                    <div class="parameter-value" id="system-status-value" style="color: var(--sea-green);">
                        Normal
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="system-status-progress" style="width: 100%; background: var(--sea-green);"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Species & Set-Point Section -->
        <section id="setpoint" class="mt-10">
            <h2 class="text-2xl font-semibold text-white mb-6">Set-Point Parameter</h2>
            
            <div class="fish-tabs">
                <div class="fish-tab active" onclick="selectFishTab(this)">
                    <i class="fas fa-fish fish-icon"></i>
                    <span>Lele</span>
                </div>
                <div class="fish-tab" onclick="selectFishTab(this)">
                    <i class="fas fa-fish fish-icon"></i>
                    <span>Nila</span>
                </div>
                <div class="fish-tab" onclick="selectFishTab(this)">
                    <i class="fas fa-fish fish-icon"></i>
                    <span>Gurame</span>
                </div>
                <div class="fish-tab" onclick="selectFishTab(this)">
                    <i class="fas fa-fish fish-icon"></i>
                    <span>Patin</span>
                </div>
                <div class="fish-tab" onclick="selectFishTab(this)">
                    <i class="fas fa-fish fish-icon"></i>
                    <span>Mas</span>
                </div>
                <div class="fish-tab" onclick="selectFishTab(this)">
                    <i class="fas fa-cog"></i>
                    <span>Custom</span>
                </div>
            </div>
            
            <div class="card">
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Suhu (min/max)</span>
                        <span id="temp-value">26째C - 30째C</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="range" min="20" max="35" value="26" class="range-slider" id="temp-min" oninput="updateTempRange()">
                        <input type="range" min="20" max="35" value="30" class="range-slider" id="temp-max" oninput="updateTempRange()">
                    </div>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>pH (min/max)</span>
                        <span id="ph-value">6.5 - 7.5</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="range" min="4" max="9" step="0.1" value="6.5" class="range-slider" id="ph-min" oninput="updatePhRange()">
                        <input type="range" min="4" max="9" step="0.1" value="7.5" class="range-slider" id="ph-max" oninput="updatePhRange()">
                    </div>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Oksigen Terlarut (min)</span>
                        <span id="do-value">5 mg/L</span>
                    </div>
                    <input type="range" min="1" max="10" step="0.1" value="5" class="range-slider" id="do-min" oninput="updateDoValue()">
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Kekeruhan (max)</span>
                        <span id="ntu-value">20 NTU</span>
                    </div>
                    <input type="range" min="0" max="50" step="1" value="20" class="range-slider" id="ntu-max" oninput="updateNtuValue()">
                </div>
                
                <div class="flex justify-center mt-4">
                    <button id="submit-fish-type" class="px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-md font-bold transition-colors duration-300" onclick="validateFishType()">
                        <i class="fas fa-check-circle mr-2"></i>Submit Jenis Ikan
                    </button>
                </div>
            </div>
        </section>

        <!-- Manual Control Section -->
        <section id="manual-control" class="mt-10">
            <h2 class="text-2xl font-semibold text-white mb-6">Kontrol Manual</h2>
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <span>Aerator</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aerator-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Kecepatan Blower</span>
                        <span id="blower-value">50%</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="range-slider" id="blower-speed" oninput="updateBlowerValue()">
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Dosing Pump</span>
                        <span id="dosing-value">30%</span>
                    </div>
                    <input type="range" min="0" max="100" value="30" class="range-slider" id="dosing-speed" oninput="updateDosingValue()">
                </div>
            </div>
        </section>

        <!-- Chart Section -->
        <section id="grafik" class="mt-10">
            <h2 class="text-2xl font-semibold text-white mb-6">Grafik Parameter</h2>
            <div class="card">
                <div class="chart-container">
                    <canvas id="parameterChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Notification Section -->
        <section id="notifikasi" class="mt-10 hidden">
            <h2 class="text-2xl font-semibold text-white mb-6">Notifikasi</h2>
            <div class="card">
                <div id="notification-list">
                    <!-- Notifications will be displayed here -->
                </div>
            </div>
        </section>

        <!-- Fish Type Validation Modal -->
        <div id="fishTypeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-xl font-semibold mb-4">Konfirmasi Set-Point</h3>
                <p id="modalMessage" class="mb-6">Anda yakin ingin menggunakan set-point untuk ikan ini?</p>
                <div class="flex justify-end gap-3">
                    <button onclick="document.getElementById('fishTypeModal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                        Batal
                    </button>
                    <button id="confirmSubmit" onclick="submitFishType()" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600">
                        Ya, Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- MQTT Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.6.1/mqtt.min.js"></script>

        <script>
            // ========== MQTT CONFIGURATION ==========
            // IMPORTANT: use WSS when hosting on HTTPS (GitHub Pages)
            const brokerUrl = 'wss://broker.emqx.io:8084/mqtt';
            const topicSensorA = "tes/18173/topic/sensorA";  // Temperature
            const topicSensorB = "tes/18173/topic/sensorB";  // pH
            const topicSensorC = "tes/18173/topic/sensorC";  // Dissolved Oxygen
            const topicSensorD = "tes/18173/topic/sensorD";  // Turbidity (NTU)
            const topicSensorE = "tes/18173/topic/sensorE";  // TDS
            
            // Control topics
            const topicAerator = "tes/18173/topic/aerator";
            const topicBlower = "tes/18173/topic/blower";
            const topicDosing = "tes/18173/topic/dosing";
            const topicSettings = "tes/18173/topic/settings";

            const publishOptions = { qos: 1, retain: true };

            // MQTT Client - add a lightweight clientId to help broker
            const clientId = 'webclient-' + Math.random().toString(16).substr(2, 8);
            const client = mqtt.connect(brokerUrl, { reconnectPeriod: 2000, clientId: clientId, connectTimeout: 30_000 });

            client.on('connect', () => {
                console.log('MQTT connected to Bioflok System');
                client.subscribe([topicSensorA, topicSensorB, topicSensorC, topicSensorD, topicSensorE], { qos: 0 }, (err) => {
                    if (err) console.warn('Subscribe error', err);
                });
                
                // Update MQTT status
                document.getElementById('mqtt-status-indicator').className = 'status-indicator status-connected';
                document.getElementById('mqtt-status-text').textContent = 'MQTT: Connected';
                
                showNotification('safe', 'MQTT Connected', 'Terhubung ke broker MQTT');
            });

            client.on('message', (topic, message) => {
                const msg = message.toString();
                console.log(`Received from ${topic}: ${msg}`);
                
                try {
                    const value = parseFloat(msg);
                    if (isNaN(value)) {
                        console.error(`Invalid number received: ${msg}`);
                        return;
                    }
                    
                    if (topic === topicSensorA) {
                        document.getElementById('current-temp').textContent = value.toFixed(1);
                        updateProgressBar('temp', value);
                    } else if (topic === topicSensorB) {
                        document.getElementById('current-ph').textContent = value.toFixed(1);
                        updateProgressBar('ph', value);
                    } else if (topic === topicSensorC) {
                        document.getElementById('current-do').textContent = value.toFixed(1);
                        updateProgressBar('do', value);
                    } else if (topic === topicSensorD) {
                        document.getElementById('current-ntu').textContent = value.toFixed(1);
                        updateProgressBar('ntu', value);
                    } else if (topic === topicSensorE) {
                        document.getElementById('current-tds').textContent = value.toFixed(1);
                        updateProgressBar('tds', value);
                    }
                    
                    updateChartWithSensorData(topic, value);
                    checkParameterStatus();
                    
                } catch (error) {
                    console.error('Error processing MQTT message:', error);
                }
            });

            client.on('error', (error) => {
                console.error('MQTT error:', error);
                document.getElementById('mqtt-status-indicator').className = 'status-indicator status-disconnected';
                document.getElementById('mqtt-status-text').textContent = 'MQTT: Error';
                showNotification('critical', 'MQTT Error', 'Koneksi MQTT bermasalah');
            });

            client.on('reconnect', () => {
                document.getElementById('mqtt-status-indicator').className = 'status-indicator status-disconnected';
                document.getElementById('mqtt-status-text').textContent = 'MQTT: Reconnecting';
            });

            client.on('close', () => {
                document.getElementById('mqtt-status-indicator').className = 'status-indicator status-disconnected';
                document.getElementById('mqtt-status-text').textContent = 'MQTT: Disconnected';
            });

            // Helper function to publish MQTT messages
            function publish(topic, payload) {
                if (client.connected) {
                    client.publish(topic, String(payload), publishOptions, (err) => {
                        if (err) console.error('Publish error', err);
                    });
                    console.log(`Published to ${topic}: ${payload}`);
                } else {
                    console.warn('Cannot publish, MQTT client not connected');
                }
            }

            // ========== EXISTING APPLICATION LOGIC ==========
            
            // Store current setpoints
            let currentSetpoints = {
                temp: [26, 30],
                ph: [6.5, 7.5],
                do: 5,
                ntu: 20
            };

            // Track time for pH change
            let timeCounter = 0;
            
            // Initialize with empty data
            let parameterData = {
                temperature: [0.0],
                ph: [0.0],
                do: [0.0],
                ntu: [0.0],
                tds: [0.0],
                feedCount: 0,
                systemStatus: 'Normal',
                labels: ['Initial'],
                waterLevel: [100]
            };
            
            // Update progress bars based on sensor values
            function updateProgressBar(parameter, value) {
                let progressBar, min, max;
                
                switch(parameter) {
                    case 'temp':
                        progressBar = document.getElementById('temp-progress');
                        min = 20; max = 35;
                        break;
                    case 'ph':
                        progressBar = document.getElementById('ph-progress');
                        min = 4; max = 9;
                        break;
                    case 'do':
                        progressBar = document.getElementById('do-progress');
                        min = 0; max = 10;
                        break;
                    case 'ntu':
                        progressBar = document.getElementById('ntu-progress');
                        min = 0; max = 50;
                        break;
                    case 'tds':
                        progressBar = document.getElementById('tds-progress');
                        min = 0; max = 2000;
                        break;
                    default:
                        return;
                }
                
                if (progressBar) {
                    const percentage = ((value - min) / (max - min)) * 100;
                    progressBar.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
                }
            }

            // Update chart with sensor data
            function updateChartWithSensorData(topic, value) {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Ensure all arrays are synchronized
                if (parameterData.labels.length !== parameterData.temperature.length || 
                    parameterData.labels.length !== parameterData.ph.length ||
                    parameterData.labels.length !== parameterData.do.length) {
                    
                    const maxLength = Math.max(
                        parameterData.labels.length,
                        parameterData.temperature.length,
                        parameterData.ph.length,
                        parameterData.do.length
                    );
                    
                    while (parameterData.labels.length < maxLength) {
                        parameterData.labels.push(timeLabel);
                    }
                    while (parameterData.temperature.length < maxLength) {
                        parameterData.temperature.push(parameterData.temperature[parameterData.temperature.length - 1] || 0);
                    }
                    while (parameterData.ph.length < maxLength) {
                        parameterData.ph.push(parameterData.ph[parameterData.ph.length - 1] || 7.0);
                    }
                    while (parameterData.do.length < maxLength) {
                        parameterData.do.push(parameterData.do[parameterData.do.length - 1] || 5.0);
                    }
                }

                parameterData.labels.push(timeLabel);
                
                if (parameterData.labels.length > 20) {
                    parameterData.labels.shift();
                    parameterData.temperature.shift();
                    parameterData.ph.shift();
                    parameterData.do.shift();
                    parameterData.ntu.shift();
                    parameterData.tds.shift();
                }

                if (topic === topicSensorA) {
                    parameterData.temperature.push(value);
                    if (parameterData.ph.length < parameterData.labels.length) {
                        parameterData.ph.push(parameterData.ph[parameterData.ph.length - 1] || 7.0);
                    }
                    if (parameterData.do.length < parameterData.labels.length) {
                        parameterData.do.push(parameterData.do[parameterData.do.length - 1] || 5.0);
                    }
                } else if (topic === topicSensorB) {
                    parameterData.ph.push(value);
                    if (parameterData.temperature.length < parameterData.labels.length) {
                        parameterData.temperature.push(parameterData.temperature[parameterData.temperature.length - 1] || 25.0);
                    }
                    if (parameterData.do.length < parameterData.labels.length) {
                        parameterData.do.push(parameterData.do[parameterData.do.length - 1] || 5.0);
                    }
                } else if (topic === topicSensorC) {
                    parameterData.do.push(value);
                    if (parameterData.temperature.length < parameterData.labels.length) {
                        parameterData.temperature.push(parameterData.temperature[parameterData.temperature.length - 1] || 25.0);
                    }
                    if (parameterData.ph.length < parameterData.labels.length) {
                        parameterData.ph.push(parameterData.ph[parameterData.ph.length - 1] || 7.0);
                    }
                } else if (topic === topicSensorD) {
                    parameterData.ntu.push(value);
                } else if (topic === topicSensorE) {
                    parameterData.tds.push(value);
                }

                // Update chart if exists
                if (chart) {
                    chart.data.labels = parameterData.labels;
                    chart.data.datasets[0].data = parameterData.temperature;
                    chart.data.datasets[1].data = parameterData.ph;
                    chart.data.datasets[2].data = parameterData.do;
                    chart.update({ duration: 0, lazy: false });
                }
            }

            function checkParameterStatus() {
                const currentTemp = parseFloat(document.getElementById('current-temp').textContent);
                const currentPh = parseFloat(document.getElementById('current-ph').textContent);
                const currentDo = parseFloat(document.getElementById('current-do').textContent);
                const currentNtu = parseFloat(document.getElementById('current-ntu').textContent);
                
                const tempWarning = currentTemp < currentSetpoints.temp[0] || currentTemp > currentSetpoints.temp[1];
                const phWarning = currentPh < currentSetpoints.ph[0] || currentPh > currentSetpoints.ph[1];
                const doWarning = currentDo < currentSetpoints.do;
                const ntuWarning = currentNtu > currentSetpoints.ntu;
                
                const systemStatusElement = document.getElementById('system-status-value');
                const systemProgressElement = document.getElementById('system-status-progress');
                
                if (systemStatusElement && systemProgressElement) {
                    if (tempWarning || phWarning || doWarning || ntuWarning) {
                        parameterData.systemStatus = 'Warning';
                        systemStatusElement.textContent = 'Warning';
                        systemStatusElement.style.color = 'var(--coral)';
                        systemProgressElement.style.background = 'var(--coral)';
                        
                        showNotification('warning', 'Parameter Warning', 
                            'Satu atau lebih parameter di luar range set-point');
                    } else {
                        parameterData.systemStatus = 'Normal';
                        systemStatusElement.textContent = 'Normal';
                        systemStatusElement.style.color = 'var(--sea-green)';
                        systemProgressElement.style.background = 'var(--sea-green)';
                    }
                }
            }

            const fishSetpoints = {
                lele: { temp: [26,30], ph: [6.5,7.5], do: 5, ntu: 150 },
                nila: { temp: [25,30], ph: [6.5,8.5], do: 5, ntu: 50 },
                gurame: { temp: [25,30], ph: [6.5,8.0], do: 5, ntu: 25 },
                patin: { temp: [26,32], ph: [6.5,7.5], do: 4, ntu: 30 },
                mas: { temp: [20,28], ph: [6.5,8.5], do: 5, ntu: 20 },
                custom: { 
                    temp: [
                        parseFloat(document.getElementById('temp-min').value),
                        parseFloat(document.getElementById('temp-max').value)
                    ],
                    ph: [
                        parseFloat(document.getElementById('ph-min').value),
                        parseFloat(document.getElementById('ph-max').value)
                    ],
                    do: parseFloat(document.getElementById('do-min').value),
                    ntu: parseFloat(document.getElementById('ntu-max').value)
                }
            };

            let chart;
            document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('parameterChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: parameterData.labels,
                        datasets: [
                            {
                                label: 'Suhu (째C)',
                                data: parameterData.temperature,
                                borderColor: '#3e92cc',
                                backgroundColor: 'rgba(62, 146, 204, 0.1)',
                                tension: 0.1,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            },
                            {
                                label: 'pH',
                                data: parameterData.ph,
                                borderColor: '#7bdff2',
                                backgroundColor: 'rgba(123, 223, 242, 0.1)',
                                tension: 0.1,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            },
                            {
                                label: 'Oksigen (mg/L)',
                                data: parameterData.do,
                                borderColor: '#4ecdc4',
                                backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                tension: 0.1,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: 10
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 0
                        },
                        transitions: {
                            active: {
                                animation: {
                                    duration: 0
                                }
                            }
                        }
                    }
                });
            });

            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                sidebar.classList.toggle('mobile-active');
                mainContent.classList.toggle('mobile-active');
            }

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (this.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href');
                        const targetSection = document.querySelector(targetId);
                        if (targetSection) {
                            targetSection.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    }
                });
            });

            let currentFishType = 'lele';

            function selectFishTab(tab) {
                document.querySelectorAll('.fish-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                currentFishType = tab.querySelector('span').textContent.toLowerCase();
                
                if (currentFishType !== 'custom') {
                    const setpoint = fishSetpoints[currentFishType];
                    
                    document.getElementById('temp-min').value = setpoint.temp[0];
                    document.getElementById('temp-max').value = setpoint.temp[1];
                    document.getElementById('ph-min').value = setpoint.ph[0];
                    document.getElementById('ph-max').value = setpoint.ph[1];
                    document.getElementById('do-min').value = setpoint.do;
                    document.getElementById('ntu-max').value = setpoint.ntu;
                    
                    updateTempRange();
                    updatePhRange();
                    updateDoValue();
                    updateNtuValue();
                }
            }

            function validateFishType() {
                const modal = document.getElementById('fishTypeModal');
                const modalMessage = document.getElementById('modalMessage');
                const isCustom = currentFishType === 'custom';
                
                if (isCustom) {
                    modalMessage.textContent = 'Anda yakin ingin menggunakan set-point custom ini?';
                } else {
                    modalMessage.textContent = `Anda yakin ingin menggunakan set-point untuk ikan ${currentFishType}?`;
                }
                
                modal.classList.remove('hidden');
            }

            function submitFishType() {
                const modal = document.getElementById('fishTypeModal');
                modal.classList.add('hidden');
                
                currentSetpoints = {
                    temp: [
                        parseFloat(document.getElementById('temp-min').value),
                        parseFloat(document.getElementById('temp-max').value)
                    ],
                    ph: [
                        parseFloat(document.getElementById('ph-min').value),
                        parseFloat(document.getElementById('ph-max').value)
                    ],
                    do: parseFloat(document.getElementById('do-min').value),
                    ntu: parseFloat(document.getElementById('ntu-max').value)
                };

                if (currentFishType === 'custom') {
                    fishSetpoints.custom = currentSetpoints;
                }

                const data = {
                    fish_type: currentFishType,
                    ...currentSetpoints
                };

                // Send settings via MQTT
                publish(topicSettings, JSON.stringify(data));
                
                showNotification('safe', 'Set-Point Disimpan', 
                    currentFishType === 'custom' 
                    ? 'Set-point custom berhasil dikirim ke ESP' 
                    : `Set-point untuk ikan ${currentFishType} berhasil dikirim ke ESP`);
            }

            function updateTempRange() {
                const min = document.getElementById('temp-min').value;
                const max = document.getElementById('temp-max').value;
                document.getElementById('temp-value').textContent = `${min}째C - ${max}째C`;
            }

            function updatePhRange() {
                const min = document.getElementById('ph-min').value;
                const max = document.getElementById('ph-max').value;
                document.getElementById('ph-value').textContent = `${min} - ${max}`;
            }

            function updateDoValue() {
                const value = document.getElementById('do-min').value;
                document.getElementById('do-value').textContent = `${value} mg/L`;
            }

            function updateNtuValue() {
                const value = document.getElementById('ntu-max').value;
                document.getElementById('ntu-value').textContent = `${value} NTU`;
            }

            function updateBlowerValue() {
                const value = document.getElementById('blower-speed').value;
                document.getElementById('blower-value').textContent = `${value}%`;
                publish(topicBlower, value);
            }

            function updateDosingValue() {
                const value = document.getElementById('dosing-speed').value;
                document.getElementById('dosing-value').textContent = `${value}%`;
                publish(topicDosing, value);
            }

            document.getElementById('aerator-toggle').addEventListener('change', function() {
                const state = this.checked ? '1' : '0';
                publish(topicAerator, state);
                showNotification('safe', 'Aerator ' + (this.checked ? 'ON' : 'OFF'), 
                    `Aerator telah di${this.checked ? 'nyalakan' : 'dimatikan'}`);
            });

            function checkWaterLevel() {
                const currentLevel = parameterData.waterLevel[parameterData.waterLevel.length - 1];
                if (currentLevel <= 20) {
                    showNotification('warning', 'Peringatan: Tinggi air rendah', 'Tinggi air mencapai 20cm, segera lakukan pergantian air!');
                }
            }

            function showNotification(type, title, message) {
                const notificationList = document.getElementById('notification-list');
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item p-4 mb-2 rounded-md border-l-4 ${
                    type === 'critical' ? 'border-red-500 bg-red-50' : 
                    type === 'warning' ? 'border-yellow-500 bg-yellow-50' : 
                    'border-green-500 bg-green-50'
                }`;
                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="mr-3 text-lg ${
                            type === 'critical' ? 'text-red-500' : 
                            type === 'warning' ? 'text-yellow-500' : 
                            'text-green-500'
                        }">
                            <i class="fas fa-${type === 'critical' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                        </div>
                        <div>
                            <div class="font-semibold">${title}</div>
                            <div class="text-sm text-gray-600">${message}</div>
                            <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
                notificationList.prepend(notificationItem);

                const notification = document.createElement('div');
                notification.className = `notification ${type} show`;
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-${type === 'critical' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                    </div>
                    <div>
                        <div class="font-semibold">${title}</div>
                        <div class="text-sm">${message}</div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Initial checks
            checkWaterLevel();
            checkParameterStatus();
        </script>
</body>
</html>
